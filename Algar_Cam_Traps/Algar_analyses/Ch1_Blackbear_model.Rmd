---
title: "Ch1_models_Blackbear"
author: "Erin Tattersall"
date: "May 13, 2018"
output: word_document
---

  Based on model selection comparison of underlying distributions and zero-inflation, I chose an nbinom2 distribution for black bear data, with zero-inflation and ActiveDays in the ZI model (see Ch1_blackbear_modelDistribution.Rmd). However, including ActiveDays in the ZI model resulted in model convergence problems. I will therefore include ActiveDays in the conditional model with a null ZI.
  
Here I will: 
1. Double check random structure using all covariates
2. Build models with environmental covariates only  
3. Build hypothesis models with line covariates + environmental  
4. Perform model selection with AIC  
5. Calculate evidence ratios (AICwt of Best Model/ AICwt of other models)  
6. Checking residuals of Top Model
7. Model Averaging?
8. Standardize parameter estimates for easy interpretation  
Previous scale analysis showed lowland habitat and linear density measured at 1750m best explained caribou detections

## Select Active Months for Black bears
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(glmmTMB)
library(bbmle) #AICtab function
library(ggplot2)
library(lmtest)
library(reshape)
library(dplyr)
library(knitr)

```
```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#Load detection data
det <- read.csv("Seismic_nov2015-apr2018.csv")

#Load lowland data
low <- read.csv("newAVIE_lowland8buffersizes.csv")

#Combine data
det$low250 <- low$low250[match(det$Site, low$CamStation)]
det$low500 <- low$low500[match(det$Site, low$CamStation)]
det$low750 <- low$low750[match(det$Site, low$CamStation)]
det$low1000 <- low$low1000[match(det$Site, low$CamStation)]
det$low1250 <- low$low1250[match(det$Site, low$CamStation)]
det$low1500 <- low$low1500[match(det$Site, low$CamStation)]
det$low1750 <- low$low1750[match(det$Site, low$CamStation)]
det$low2000 <- low$low2000[match(det$Site, low$CamStation)]

#Load linedensity data
LineDens <- read.csv("AlgarStationsLD_Lines.csv")

# Combine datasets
det$LD250 <- LineDens$X250m[match(det$Site, LineDens$CamStation)]
det$LD500 <- LineDens$X500m[match(det$Site, LineDens$CamStation)]
det$LD750 <- LineDens$X750m[match(det$Site, LineDens$CamStation)]
det$LD1000 <- LineDens$X1000m[match(det$Site, LineDens$CamStation)]
det$LD1250 <- LineDens$X1250m[match(det$Site, LineDens$CamStation)]
det$LD1500 <- LineDens$X1500m[match(det$Site, LineDens$CamStation)]
det$LD1750 <- LineDens$X1750m[match(det$Site, LineDens$CamStation)]
det$LD2000 <- LineDens$X2000m[match(det$Site, LineDens$CamStation)]


#Load line width and veg height
sp <- read.csv("Spatial_covariates.csv")

det$VegHt <- sp$VegHt[match(det$Site, sp$Site)]
det$LineWidth <- sp$LineWidth[match(det$Site, sp$Site)]


### Cropping data for active bear months only -- April - October
unique(det$Yr_Month)
plot(det$Yr_Month,det$Blackbear)


#Filter for desired months and covariates - low500 and LD750
det <- det %>% filter(Yr_Month == "2016-04" | Yr_Month == "2016-05" | Yr_Month == "2016-06"| Yr_Month == "2016-07"| Yr_Month == "2016-08"| Yr_Month == "2016-09"| Yr_Month == "2016-10"| Yr_Month == "2017-04" | Yr_Month == "2017-04" | Yr_Month == "2017-05" | Yr_Month == "2017-06"| Yr_Month == "2017-07"| Yr_Month == "2017-08"| Yr_Month == "2017-09"| Yr_Month == "2017-10") %>% select(Site, Treatment,Yr_Month, Site_ym, Blackbear, Month, ActiveDays, pSnow,low500, LD750, VegHt, LineWidth)


## Visualising patterns using predict function (predicting new data, given the best-fit model)
## Need to first remove NAs from explanatory variables
# newdat <-  det[ , c(1,2,12:34)] #Naming columns in df
# newdat <- na.omit(newdat) ## Exluding NA rows, which causes lengths to differ
```
### 1. Random structure  
  Random structure was previously assessed, but here I will confirm using all model covariates

```{r, echo=FALSE, message=FALSE}
r0 <- glmmTMB(Blackbear~ LineWidth + LD750 + VegHt + low500 + Treatment + pSnow + ActiveDays, data = det, zi=~1,family = nbinom2)
rSite <- glmmTMB(Blackbear~ LineWidth + LD750 + VegHt + low500 + Treatment + pSnow + ActiveDays + (1|Site), data = det,zi=~1, family = nbinom2) 
rMonth <- glmmTMB(Blackbear~ LineWidth + LD750 + VegHt + low500 + Treatment + pSnow + ActiveDays  + (1|Month), data = det, zi=~1, family = nbinom2)
r2 <- glmmTMB(Blackbear~ LineWidth + LD750 + VegHt + low500 + Treatment + pSnow + ActiveDays + (1|Site) + (1|Month), data = det, zi=~1,family = nbinom2)
ICtab(r0, rSite, rMonth, r2, type= "AIC", weights = TRUE, delta = TRUE, logLik = TRUE, sort=TRUE)
```

## Environmental models  
Model Name  | Covariates
----------- | -------------------
E1          | ActiveDays
E2          | ActiveDays + low500 + pSnow
E3          | ActiveDays + low500
E4          | ActiveDays + pSnow

```{r, echo=FALSE}
E1 <- glmmTMB(Blackbear~ActiveDays + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#2. Global model
E2 <- glmmTMB(Blackbear~ActiveDays + low500 + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#3. Lowland only
E3 <- glmmTMB(Blackbear~ActiveDays + low500 + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#4. Snow only
E4 <- glmmTMB(Blackbear~ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

ICtab(E1, E2, E3, E4, type= "AIC", weights = TRUE, delta = TRUE, logLik = TRUE, sort=TRUE) 
```  
  As in the Wolf models, E4 and E2 perform very similarly, with the pSnow model coming out slightly on top. Model deviance is only ~1 unit separate and lowland does not appear to have much of an effect. However, perhaps lowland has an effect when adding other variables?  
  Compare global models with and without lowland habitat.  
```{r, echo=FALSE, results='hide'}
summary(E4)
summary(E2)
```
```{r, echo=FALSE, message=FALSE}
wLow <-  glmmTMB(Blackbear~ Treatment + LineWidth + LD750 + VegHt + low500 + pSnow + ActiveDays + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)
woLow <-  glmmTMB(Blackbear~ Treatment + LineWidth + LD750 + VegHt + pSnow + ActiveDays + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)
ICtab(wLow,woLow, type= "AIC", weights = TRUE, delta = TRUE, logLik = TRUE, sort=TRUE) 
```  
  As in the simpler models, the global model without lowland habitat has more model weight, but still within 2 AIC points. This provides more evidence that lowland habitat may just be a 'pretending variable,' and I will exclude it from further analysis.  
  
## Line characteristics  
Model Name  | Covariates
----------- | -------------------
L1          | Treatment + pSnow + ActiveDays
L2          | VegHt + pSnow + ActiveDays
L3          | LD750 + pSnow + ActiveDays
L4          | LineWidth + pSnow + ActiveDays
L5          | Treatment + LineWidth + pSnow + ActiveDays
L6          | LineWidth + VegHt + pSnow + ActiveDays
L7          | Treatment + LD750 + pSnow + ActiveDays
L8          | LD750 + VegHt + pSnow + ActiveDays
L9          | Treatment + VegHt + pSnow + ActiveDays
L10         | Treatment + LineWidth + VegHt + pSnow + ActiveDays
L11         | Treatment + LineWidth + LD750 + pSnow + ActiveDays
L12         | Treatment + VegHt + LD750 + pSnow + ActiveDays
L13         | LineWidth + VegHt + LD750 + pSnow + ActiveDays
L14         | Treatment + LineWidth + LD750 + VegHt + pSnow + ActiveDays  

```{r, echo = FALSE, warning=FALSE, message=FALSE, results='hide'}
#1. Treatment
L1 <- glmmTMB(Blackbear~Treatment + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#2. VegHt
L2 <- glmmTMB(Blackbear~ VegHt + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#3. Line density
L3 <- glmmTMB(Blackbear~ LD750 + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#4. Line Width
L4 <- glmmTMB(Blackbear~ LineWidth + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#5. Treatment + LineWidth
L5 <- glmmTMB(Blackbear~ Treatment + LineWidth + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#6. LineWidth + VegHt
L6 <- glmmTMB(Blackbear~ LineWidth + VegHt + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1,family = nbinom2)

#7. Treatment + Line density
L7 <- glmmTMB(Blackbear~ Treatment + LD750 + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#8. Line density and VegHt
L8 <- glmmTMB(Blackbear~ LD750 + VegHt + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#9. VegHt + Treatment
L9 <- glmmTMB(Blackbear~ Treatment + VegHt + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#10. Treatment, LineWidth, VegHt
L10 <- glmmTMB(Blackbear~ Treatment + LineWidth + VegHt + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#11. Treatment, LineWidth, Line density
L11 <- glmmTMB(Blackbear~ Treatment + LineWidth + LD750 + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#12. Treatment, Line density, VegHt
L12 <- glmmTMB(Blackbear~ Treatment + VegHt + LD750 + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#13. LineWidth, VegHt, Line density
L13 <- glmmTMB(Blackbear~ LineWidth + VegHt + LD750 + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

#14. Global model - Treatment, Line density, VegHt, LineWidth
L14 <-  glmmTMB(Blackbear~ Treatment + LineWidth + LD750 + VegHt + ActiveDays + pSnow + (1|Site) + (1|Month), data = det, zi=~1, family = nbinom2)

BlackbearAIC <- ICtab(E1, E2, E3, E4, L1, L2, L3, L4, L5, L6, L7, L8, L9, L10, L11, L12, L13, L14, type= "AIC", weights = TRUE, delta = TRUE, logLik = TRUE, sort=TRUE)
BlackbearAIC
```
  3 models within 2 dAIC points of each other, with model weights between 16 - 43%  
  VegHt is present in top 5 models, Treatment doesn't appear until 4th model  
  
## Evidence Ratios and Cumulative model weight (calculating confidence intervals)
  
  Calculating evidence ratios (AIC wt of best model/AIC weight of others) gives:
  
```{r,echo=FALSE, results='hide'}
EvR <- function(AICwt.high, AICwt.low){
  EvR <- AICwt.high/AICwt.low
  print(EvR)
}
EvR(BlackbearAIC$weight[1], BlackbearAIC$weight[2])
BlackbearWt <- BlackbearAIC$weight
BlackbearER <- vector(length=17)
for(i in 2:18){
  BlackbearER[i-1] <- EvR(BlackbearWt[1], BlackbearWt[i])
}
```
```{r,echo=FALSE}
BlackbearER <- append("", BlackbearER)
ER <- as.data.frame(BlackbearER)
ER$dLogLikelihood <- BlackbearAIC$dLogLik
ER$dAIC <- BlackbearAIC$dAIC
ER$Modelweight <- BlackbearAIC$weight
ER$ModelNames <- c("L2", "L6", "L8", "L9", "L13", "L12", "L10", "L4", "L14", "L5", "L11", "E4", "E2", "L3", "L1", "L7", "E1", "E3")
ER$weight.cum <- rep(NA,18)
ER$weight.cum[1] <- ER$Modelweight[1]
for (i in 2:length(ER$Modelweight)){
  ER$weight.cum[i] <- ER$Modelweight[i] + ER$weight.cum[i-1]
}

ER <- ER %>% select(ModelNames, dLogLikelihood, dAIC, Modelweight, weight.cum, BlackbearER)
colnames(ER) <- c("ModelNames", "dLogLikelihood", "dAIC", "Modelweight", "CumulativeWeight", "EvidenceRatio")
ER

```  
###Summary Output for Top Model
  
````{r, echo=FALSE}
summary(L2)
```


### Plotting residuals against fitted values and predicted values for all covariates
```{r, echo=FALSE}

## Residual plot for global model(L2)
op <- par(mfrow = c(1,2))
pred <- predict(L2, zitype = "response")
resid <- residuals(L2)

## Plot residuals against predicted --> diagonal lines characteristic of discrete data

{plot(pred, resid, main = "Residuals vs. Predicted", xlab = "Predicted Values", ylab = "Residuals")
abline(h = 0, lty = 2)  
lines(smooth.spline(pred, resid))}
{plot(fitted(L2), residuals(L2), main= "Residuals vs Fitted", xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2)
lines(smooth.spline(fitted(L2), resid))}



```
